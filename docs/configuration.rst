.. _configuration:

****************
Configuration
****************

.. contents:: :local:

General
--------

`err-stackstorm` configuration lives in Errbot's `config.py` file.

.. note:: If you followed the Errbot setup documentation this file will have been created by downloading a template. If this file has not already been created, please create it following the `Errbot's instructions <http://errbot.io/en/latest/user_guide/setup.html#id1>`_.

Here's a sample err-stackstorm configuration:

.. code-block:: python

    STACKSTORM = {
        'auth_url': 'https://your.stackstorm.com/auth/v1',
        'api_url': 'https://your.stackstorm.com/api/v1',
        'stream_url': 'https://your.stackstorm.com/stream/v1',
        'route_key': 'errbot',
        'plugin_prefix': 'st2',
        'verify_cert': True,
        'secrets_store': 'cleartext',
        'api_auth': {
            'user': {
                'name': 'my_username',
                'password': "my_password",
            },
            'token': "<User token>",
            'apikey': '<API Key>'
        },
        'rbac_auth': {
            'standalone': {},
        },
        'timer_update': 900, #  Unit: second.  Interval to check the user token is still valid.
    }

ST2 ChatOps Configuration
--------------------------

StackStorm's `ChatOps pack <https://github.com/StackStorm/st2/tree/master/contrib/chatops>`_ has to be installed and a notify rule file added to the pack.

The notify rule must be placed in ``/<st2>/packs/chatops/rules``. You can find the rule file necessary for `err-stackstorm` `here <https://raw.githubusercontent.com/nzlosh/err-stackstorm/master/contrib/stackstorm-chatops/rules/notify_errbot.yaml>`_. Just copy-and-paste this file and save it as ``notify_errbot.yaml``.

Edit the ``/<st2>/packs/chatops/actions/post_message.yaml`` file and replace `chatops` with ``errbot``:

.. code-block:: yaml

  route:
    default: "errbot"

.. note:: See Route Key below for information on customising the route.

Authentication
---------------

`err-stackstorm` must have valid credentials to use StackStorm's API.
Stackstorm's authentication is possible with:

* Username and password
* User token
* API key

See `Stackstorm's Authentication docs <https://docs.stackstorm.com/authentication.html>`_ for more details on how to generate credentials.

Username/Password
^^^^^^^^^^^^^^^^^^

Using a username and password will allow `err-stackstorm` to renew the user token once it expires.

.. note:: If you specify both username/password and a User Token, the User Token will be used and the *username/password will be ignored*.

User Token
^^^^^^^^^^

To avoid using the username/password pair in a configuration file, it's possible to supply a User Token as generated by StackStorm when a username/password is authenticated successfully.

If using an User Token `err-stackstorm` will no longer have access to the Stackstorm's API once it expires.

.. note:: When the token expires, a new one must be generated and updated in config.py which in turn requires Errbot to be restarted. This form of authentication is the least practical for production environments.

API Key
^^^^^^^^

*API Key support has been included since StackStorm v2.0.*

When an API Key is provided, all other authentication settings are ignored and the API Key is used.

If using an API Key, `err-stackstorm` will no longer have access to the Stackstorm's API once it expires.

.. note:: It is considered a mistake to supply a token or username/password pair when using the API Key.

Secrets Store
^^^^^^^^^^^^^^

The secrets store is used by `err-stackstorm` to cache StackStorm API credentials. The available backends are:

* cleartext


Cleartext
""""""""""

The cleartext store maintains the cache in memory and does not encrypt the contents to disk. It **does not** protect the stored secrets in memory.

Route Key
---------

StackStorm ChatOps uses `routes` to indicate where a notification should be sent.  By default the StackStorm ChatOps pack uses **chatops** as the route kei to send messages when an action result is posted.  It is possible to run more than one errbot instance per StackStorm instance by configuring different route keys.  Such a feature would allow running one errbot instance that listens on Slack and another that listens on Discord, where both would expose StackStorm's action-aliases.

Plugin Prefix
-------------

Errbot detects commands using a **bot_plugin** prefix, often ``!`` character.  Errbot functionality is extended through plugins.  Plugins register new commands with Errbot as they are loaded.  Err-stackstorm is a plugin and adds a special command for calling StackStorm Action-Aliases.  To avoid name collisions between *Errbot Commands* and *StackStorm Action-Aliases*, a **plugin_prefix** is used which is ``st2`` by default.  The plugin_prefix can be customised to be any string, but be careful not to use strings that conflict with existing commands.

Locale
-------

Errbot uses the system's locale for handling text. If you're getting unicode errors like this::

  UnicodeEncodeError: 'ascii' codec can't encode character '\xe9' in position 83: ordinal not in range(128)

Make sure the systems locale is configured for unicode encoding. In the example below, the machine has been set to English (en) New Zealand (NZ) with utf-8 encoding (.UTF8).

.. code-block:: bash

  # locale
  LANG=en_NZ.UTF8
  LANGUAGE=
  LC_CTYPE="en_NZ.UTF8"
  LC_NUMERIC="en_NZ.UTF8"
  LC_TIME="en_NZ.UTF8"
  LC_COLLATE="en_NZ.UTF8"
  LC_MONETARY="en_NZ.UTF8"
  LC_MESSAGES="en_NZ.UTF8"
  LC_PAPER="en_NZ.UTF8"
  LC_NAME="en_NZ.UTF8"
  LC_ADDRESS="en_NZ.UTF8"
  LC_TELEPHONE="en_NZ.UTF8"
  LC_MEASUREMENT="en_NZ.UTF8"
  LC_IDENTIFICATION="en_NZ.UTF8"
  LC_ALL=en_NZ.UTF8


Reference
----------


  .. csv-table::
    :header: "Option", "Description"
    :widths: 25, 40

    "auth_url", "StackStorm's authentication url end point.  Used to authenticate credentials against StackStorm."
    "api_url", "StackStorm's API url end point.  Used to execute action aliases received from the chat back-end."
    "stream_url", "StackStorm's Stream url end point.  Used to received ChatOps notifications."
    "verify_cert", "Default is *True*.  Verify the SSL certificate is valid when using https end points. Applies to all end points."
    "route_key", "Default is *errbot*. The name of the route to bot will listen for and submit action-alias executions with."
    "plugin_prefix", "Default is *st2*. Text used to prefix action-alias commands with to avoid name collisions between StackStorm Action-Aliases and Errbot plugin commands."
    "api_auth.user.name", "Errbot's username to authenticate with StackStorm."
    "api_auth.user.password", "Errbot's password to authenticate with StackStorm."
    "api_auth.token", "Errbot's user token to authenticate with StackStorm. Used instead of a username/password pair."
    "api_auth.apikey", "Errbot API key to authenticate with StackStorm. Used instead of a username/password pair or user token."
    "timer_update", "Unit: seconds. Default: 60.  Interval for err-stackstorm to the user token is valid."
    "rbac_auth.standalone", "Standalone authentication."
    "rbac_auth.clientside", "Clientside authentication, a chat user will supply StackStorm credentials to err-stackstorm via an authentication page."
    "rbac_auth.clientside.url", "Url to the authentication web page."
    "session_ttl", "Unit: seconds.  Default: 3600.  The time to live for a authentication session."
    "user_token_ttl", "Unit: seconds. Default: 86400.  The time to live for a StackStorm user token."
    "secrets_store.cleartext", "Use the in-memory store."

